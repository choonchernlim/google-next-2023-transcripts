{
    "title": "Building next-generation databases at Google: Cloud Spanner under the hood",
    "presentation_type": "Breakout",
    "categories": [
        "Database Professionals",
        "DBS302"
    ],
    "video_id": "eezLzbcqrdg",
    "time": "Aug 30 11:15 AM - 12:00 PM CDT",
    "transcript": "foreign[Music]thanks for being here hope you're havingan awesome conference so you are in thebuilding Next Generation databases Cloudspanner under the hood session I ampratiba Surya devara I lead the spannerengineering both for internal offeringand also the cloud offeringpresent the session with me I have ChrisTaylorVP Google fellow one of the originalauthors of the spanner paper it's aprivilege to present with him and I haveJohn Fisher who is head of engineeringfor Google photosthanks folksokay during the course of next 45minutes what we wanted to do is walk youthrough what spanner is why we startedwith spanner then Chris will walk usthrough the technical details under thehood on what makes spanner what it isand then we'll have John walk throughhow Google photos leverages spanner andthe end of it we should have about 10minutes or so for Q a so I'd request allof you to line up at the mic if you haveany questions if you run out of time allthree of us will be available outside sowe can have a chat after the after thesessionso let's start with what spanner wassoin in 2009 as Google was one of theearly disruptors on reimagining how thebusinesses should be done online weactually faced four challenges one islack of horizontal scale two is thefrequent downtime the businesses had totake three is the high operational tileThe Operators had to deal with and fouris a load developer productivity lookingat the systems we had at that time wecame up with a conclusion that we neededto build a system like spanner that hasthese distributed capabilities to kindof take care of these challengesinterestingly these are the very similarchallenges that I hear from our externalcustomers today all of you as you'rebuilding your businesses you'redisrupting whatever domains you are inyou face the same challenges aroundyou're reaching out to your customers indifferent channels the scale at whichyou're talking to your customers thefeatures that you're providing for toyour customer customers you run into thesame scale challenges you're actuallylooking at the similar challenges aroundoperational tile and also the developerproductivity that you have and the lastpiece is as you build these systemsmanually operating these self-managingthem becomes very complicated at acertain scaleso what we did was let's build adatabase that our customers can trustwhat do we mean by that I think spannerdatabase as it built provided thehighest availability in the industrytoday it provides the horizontal scalethat you need it also has zero downtimethat you look for your businesses andalso a lot of your businesses in retailand all need that zero downtimeespecially in the environments you scaleso having that horizontal scalecapability is awesomesecond we wanted to build a system thatyou can innovate on right all the wayfrom leveraging your existing skills weprovide open interfaces like postgresand also a lot of your businesses todaydon't run just one type of workloads youhave transactional workloads you haveanalytic needs the system and thearchitecture that we built gives youthat environment where you can runhybrid workloads last the thirdprimitive I want to talk about is theproductivity like a manage I talkedabout earlier a fully managed spanner iswhat we build for our customers so thatyou can spend your time and yourdeveloper productivity on what'simportant for your business versusmanaging this infrastructureso with this kind of infrastructure thatwe built this is where spanner is todayhugely adopted inside and outside ofGoogle today we have around 3 billionQPS running on spanner 12 exabytes ofdata under management and the customersthat we have starting internal withGoogle all the way from ads to YouTubeto photos to Chrome to search to Androidto gpay and all the Google workspacesCalendar Gmail maps all of that runsunder spanner today in addition insideof Google Cloud all the control planesfor GCS gke IAM all of that is built onspanner for our external customersall the way from gaming to retail tofinancial to health care to social mediato Transportation these are all theexternal customers running on spannertodayso we've built this amazing platformthat gives you the reliability the scalethe architecture the extensibility thatyou need let me hand it over to Chrishe'll walk us to what we did to get tothis architecturethank you hi my name is Chris Taylor andI'm going to talk through the key piecesof spanner and how they work together tomake spanner a great database forapplications that matterreally we start with scaleClips are scary it's a failure at amoment when something is something goodis happening to your businessand so we built spanner to handle handleimmense workloadsthis was actually one of the easierthings that we did because Google atthat stage had lots of experiencebuilding exabyte scale storage and keyvalue stores and a lot of that same DNAis underneath spannerumalong the way we were really careful tomake it work well for small users aswell we wanted this to be for Google'sworkloads of all kinds and our customerworkloads of all kindsand really it's amazing seeing ourcustomers feel safe knowing they're farfar Far From Any scale limit that wehavein High availability was sort of thenext principle here we had all used hadrimplementations where you have a bigbang failover and it's kind of built asan add-on you build the first system andthen you build a second one and you failover to itthe reality of the cloud in ourexperience is that at scale failures aresmall but frequent and a system thatroutes around these transparently andautomatically works much better inpractice and so this is how we tried todo spanner we added fine-grained tabletlevel failover SQL queries that restartwhen they hit bad machines and things ofthat kind and as a result spannersurvive small medium and even largeproblems with low impactwe also carefully designed our justordinary life cycle events schemachanges software upgrades these happenfully online we have no notion ofMaintenance downtimespanner also offers multi-regioncapabilities and this this stems fromrealizing that the leap from one regionto two or more is a big challenge for anapplicationdo you want to redesign with eventualconsistency in minddo you want to have these rarelyexercised monolithic failovers with thepossibility of data losswe aim to make geodiversity really aseasy as possible we built rpo0replication which brings you an extranine of availabilityand we have the option to add extra readreplicas near your customers for reducedread latencywe also recognizing that you know notevery customer that needs multi-regionstarts with multi-region we implementedan upgrade from Regional spanner tomulti-region spanner that you can usewhen you need it the transition is fullymanaged and online so you can startsmall and build upanother reality of working with bigproduction databases is that trafficshifts are a realitythe usage of an application is hard topredict your app changes the worldchanges around you and a result as aresult the pattern of traffic to yourkey spaces shift and often the way youwere sharded before is invalid a minutelaterso with spanner we built stronginsurance against those kinds ofproblems both online scaling so you canjust add more nodes when you need tohandle more trafficbut also fast inter server loadbalancing and key range splittingand these capabilities combined can turnmost hot spots into non-eventsreally spanner handles it and you nevereven realize it happened to youmany of these strengths come fromSpanish compute storage separationwe have one tier of servers that handlesyour queries and another tier of serversthat stores your data called Colossusand this lets us radically rebalanceread and write loads on the fly withoutdata copies it also means that when oneof your query servers is lost you'veonly lost a small fraction of your cashand you really don't even notice thatthat this is happeningseparately we have a lot of experiencebuilding key value applications we'vedone many of them we've seen how theygrow upthe first 80 of a key value applicationis invariably easy and funit's a it's a friendly way to modeland it's easy to see how the basicpatterns of your application mapbut it's very common in my experiencethat the last 20 percent of that appneeds a few more things from thedatabase and this is where the long tailof these work workarounds drives a lotof the complexity in the application bythe time it's done it doesn't look assimple as how it startednow Engineers including myself are verycreative almost anything can be made towork if you try hard at it but what wesaw with spanner is a big opportunity tomake our customers more productive andtheir apps simpler and more maintainablesoI put a subset of the features on hereI won't walk through them all but manyspanner applications do stick to plainvanilla key values and spanner handlesthat very well if you don't need morethe base system can handle your keyvalue workload with good priceperformance and good performancebut we do see that many apps start thatway and then eventually reach for a fewmore capabilities from the tool bagwhether it's transactions or indexes ora little bit of SQL or whateverand we're constantly adding more herewe're working with our customers tounderstand what their most common designpatterns are and where they're hurtingthe most and we try to add features thatcan really take that complexity andbundle it into a beautiful packagea great example is something we've justannounced Cloud spanner data boostmany apps have fresh and valuable databut it's locked away from analyticsbecause of fear of the impact of thoseworkloads on servingwe know we all know how this is commonlydealt with there's ztl and extra copiesof data or dedicated analytics replicaswith data boost we have a third wayyou can query spanner from bigquery ordata flow or the analytics system ofyour choice with strong isolation and nofixed costsso really you're just paying for theusage of your queriesand this is again a consequence ofcompute storage separation we're able touse an on-demand pool of query workersto run your data boost query the momentyou get them again with no fixed costsalso because of this compute storageseparation we're often able to applymore resources to your queries and runthem significantly faster through higherparallelismthis is an exciting example ofa really common pattern needing to runanalytics on your operational data thatis more hands-off than eversort of wrapping up herewe're trying to build the most capablescale out database in the worldand we're not doing it because everycustomer needs every feature but becausewhen you start out you don't know whatyou'll need by the time you arrive withyour customers and really land your workand we want you to be ready for anythingand with that I'm going to hand back topratiba to show some of the ways Googlehas benefited from its no compromisedatabasecontinuing let me walk through someexamples of a little bit breadth firstlook at how different applications andservices inside of Google use Bannerso like Chris mentioned the tenants thatwe built spanner with enables all ofGoogle to run on spanners today like Isaid before Google runs on spanner allthe way from Google applications likeGmail YouTube calendar Maps ads photosjust to say a fewall the workspace applicationsGmail Drive calendar meet sheets docsand all the Google control planes forservices like gke GCS IAM all of thisrun on spanner today in addition we havealphabet companies like waymo and verilyalso run spannerso let me walk through some use cases onwhy spanner what motivated them andwhere are they today let me start withads ads was initially built as aself-managed MySQL workloadthe scale to which they got became aproblem where the MySQL was not scalingfor them and also the frequent downtimesthat they had to do whether to upgradethis stack or outages because of thescale kind of became Revenue impactingfor them this is one of the firstapplications we started working onspanner so we worked with them veryclosely at this point all of a lot ofads use cases whether it's auctioningwhether it'sgiving ads to the web pages or theirpayment systems all of them run onspanner it's been over a decade or sosince ads been is running on spannerwe've not seen a single downtime that isrevenue impacting with ads on spannerso the second application I want to talkto you about is YouTube YouTube isanother sharded MySQL which was built onvitess they started running intochallenges where they're both the costof the infrastructure because each ofthe applications they built whether itis their music or streaming each of themwas built on different stacks and alsothe downtime and the fragmented StorageSolutions was becoming too expensive forthem and their initial architecture wasalso built on the very challengingarchitecture on lamp which was notscaling them after a scaling for themafter a certain scaleso they started migration to spanner sotoday they launched multiple productslike music kids shots TV on a singleinfrastructure which is the mostreplicated data set across multipleregions which is giving them a very highresource efficiency and operationalSimplicity this is also a helping themtransform large processing pipelines fortheir business things like spamfiltering things like personalizationand stuff which gives them the strongconsistency they need across regions andalso the security and privacy andcompliance they needmoving on the next application I want totalk to you about is Google pay Googlepay in India Google pays as you know amobile payment service used for in-appin person and also online contactlesspayments today Google pay serves aroundhundreds of millions of customers doingbillions of transactions monthly whatwas important for them was a low latencyand massive scale a lot of you in retailknow that the scale when for the eventslike cyber Mondays black FridaysFestival Seasons like Diwali in India iswhere your infrastructure gets stressedout and where your reputation whetherthe system is scaling or not and how itscales and how much preparation thatgoes into it becomes very critical forthe infrastructure providers so gpaytoday they're able to scale because ofthe spanner infrastructure in additionespecially retail and Financialcustomers have these regulations andcompliance so all of that is offloadedby spanner for these customersand another customer our own informationretrieval systems inside of Google itthis system started more for indexingand serving the web pages but over timeit became a multi-tenant infrastructurethat's used for multiple corporas publicand private YouTube Gmail photos bunchof these systems right these systemsdon't at this point just live withserving and indexing they have toprovide lot more differentiated featuresso having spanner as this uniforminfrastructure gives them thereplication the resiliency theredundancy they need and they're alsoable to quickly iterate on the featuresthey need to build one of theinteresting things is because they'vemerged all these into a single systemall the bespoke solutions become one andthe infrastructure Simplicity andoperational Simplicity is what we arebig is becoming simpler on top of it thesearch capabilities on spanner givesthem a single place for them to do andnot only do serving but they're able todo analytics and search and also thisopens up similarity search and AI usecases for themthe one last use case I want to talk toyou about is Chronicle this is in oursecurity space Chronicle is a GoogleEnterprise service where customers canactually privately store analyze anddetect any of the risky behavior intheir Network or security Telemetry sothis system again is a single store theyuse globallyanalyzingexabytes of data within sub seconds oflatency is what they get by usingspannerwith that I gave you a brief overview ofinternal use cases across differentspectrums across different verticalsinside of Google let me hand it over toJohn who will give us a much deeper lookat how Google photos uses spannerthanks pratifah hey everyone I'm JohnFisher it's great to be here I'm asenior director of engineering at Googleleading engineering for Google photosso I'm sure many of you know but Googlephotos is the home for your memoriesum it's a photo storage sharingreminiscing service that offers acomplete consumer user workflow acrossdevices so that users can automaticallybackup organize edit search andreminisce about their most preciousmomentsand all those power all those are builtwith ML and AI at its coreGoogle photos has a global user basewith over a billion monthly active usersand our Corpus size is over 4 trillionphotos and videosand so photos needs a database that canscale to that sizeacross a wide variety of read and writepatternsand so for photos that database isspanner and we store tens of petabytesacross dozens of geographies to serveour userslet's look at the life of a photo as auser captures it and goes up into oursystemsso a user captures the photo on theirdevice and will upload those photos intoour product if the user has the backupfeature enabled and of course backup isone of our most popular features becauseit enables users to have the trust andpeace of mind that their content is safeand so backup happens in two phasesfirst we upload the actual bytes of themedia into our encrypted blob storageand we use GCS for thatnext we take we upload and encrypt themetadata into spanner things like the XFdata from images the file name and otherproduct specific metadataand so at that point we've got we've gotthe content we've got it safely storedand users trust us with that data and sowe take privacy and security reliabilityincredibly seriouslyso uploading the content and themetadata into the spanner and GCS isjust the tip of the iceberg at thatpoint a whole bunch of asynchronousprocessing kicks off and this is all ofour machine learning and all of ourinferencingand all that processing is funneledaround spanner which is the hub for ourmachine learning workflowsthese machine learning feature machinelearning models power our features toorganize to enable search andreminiscingand latency is very important for usthat we can deliver these features toour users shortly after uploadso let's take an example let's say thatI was out hiking the other day andwanted to search for that photo of awaterfalland given that this is a presentationwith Google photos I had to include someof my own photos as well so there's aselection of my waterfallsafter a photo is uploaded to our systemwe cue that photo up for various formsof that offline image processing mlinferencing that helps us labelunderstand and organize the user's mediainto the librarywe infer the semantic contents of anupload and understand both at anindividual level but also at anaggregate level about how that piece ofcontent fits into the overall Libraryand to do that it involves many largecomplex spanner queriesthat happen concurrently with many otherreads and writes they're running on thatuser so we have this asynchronousprocessing meanwhile the user continuesto browse and share and edit withintheir app and so having those differentread and write workflows happensconcurrently is a key part of the designthing the design principles that spannerenables hereso once we've done that in machinelearning processingprocess those signals and those labelswe store them back into spanner and thenwe index them into our Downstreamindexing system to enable for our searchour search use caseso we can find those photos of waterfallso overall this is a reasonablyconceptually simple architecture ofuploading content into our our back endstoring in our our blob storage and ourour database and having some of thatasynchronous processing so overall it'sgot a simple mental model but that'sreally just the tip of the icebergbecause we have over hundreds ofbinaries and microservices and processesto deliver on our product goalsand all those microservices havedifferent access patterns that rangefrom small lookups to large data scanswith a variety of latency andreliability requirementsspanner has met every requirement we'vehad off the shelf it's been incrediblyflexible easy to useespecially given our massive scaleas an example we have a global user baseand users like to organize their contentinto albums and share them with eachotherand so that type of cross user sharingrequires you know seamless real-timesharing and spanners Global indexes helpus deliver on that goalso I've walked you through a bit of thesystem diagram of Google photosand I wanted to kind of step back andhighlight a few of the guidingprinciples that have carried us forwardas we interact with spannerand I want to use kind of a fun sillylittle castle metaphor to illustratesome of thatand in case you're wondering yes thecastle is AI generatedso photos continues to use a singleunified databaseto power our application and this is thefoundation of our Castle it's the rockthat we've built on and so despite ourlarge size and growth in both usersitems and queries per secondwe've been able to continue to sustainon this single unified databasearchitecturenavigating through our global globalneeds and that's yielded a simplerdevelopment experience a moremaintainable architecture enabling us tolean into microservices navigate andmanage our technical debt and support atight release cycle so many of theprinciples that in the tenants thatChris laid out earlier we've really seenthem flow through in in our usage of theproductour next principle is around strongconsistency and high concurrency and sothese are the strong walls of our Castlewe have strict consistency andconcurrency needs and that makes sensewhen you think about that mix ofworkflows workloads I talked about theasynchronous batch processing and theinteractive user reads and writes of thethe product having that happen togetherconcurrently as well as the cross usernature of our product where users loveto share their content and having thatcross user consistency that's importantand so spanners high right throughputand consistency guarantees ResourceManagement tools allow photos to buildand scale these features and pipelinesby over 10x with minimal re-architectureso we've really hit that goal of kind offuture proofing our further growth andour database is user-centricand we lean heavily on that asynchronousprocessing for efficiency and latencyreasonsso overall we're able to kind of deliveron all thatcomplexity of the hundreds ofmicroservices while still delivering onour product goalscoming back to kind of the enabling ofthose ml workflows data needs to flow inand out of our Castle our datawe have that rich set of ml poweredfeatures that rely on our ability tounderstand the semantic content of auser's content and their overall Libraryand so again going back to that searchexample we have a wide variety ofsignals that we label each contentaround and store all that information inspannerand using those signals in a variety ofother metadata we associate across thesecontents within an account to determinethe most meaningful moments for a givenuserand all of this functionality requiresdifferent database workloads we've builta queuing system on top of spanner thatallows us to reliably process thosethose work items and we for the searchexample again we have a variety of scanslookups Point lookups and joins atsearch timeour memories feature which kind of has acollection around a trip or a momentrequires large scans secondary indicesand additional tables with derivedmetadata to power thatwe also do clustering like clustering ofa thing or a person and those thoseoperations require us to look at all thephotos within a user's account combininglarge scans and streaming approachesso despite the wide variety of kind ofworkloads and different needs herespanner is able to meet all of thiscompletely off the shelf for usI mentioned that privacy and security isat our corewe really need to deliver on a userexpectation of trust privacy andsecurityand that's the layer of protectionaround our Castleusers store their most precious momentswith with us and so we want to ensurethatdata is encrypted at rest tightly AccessControl to protect against Bad actorsand unauthorized access and that thesecurity and privacy best practices arekind of baked in from the core so we canconfidently execute on additionalfeaturesand we care incredibly about reliabilityas well and so we're confident thatusers data is always available when theyneed it with a variety of data Integritychecks as well as backups for DisasterRecoveryour final principle is aroundoperational excellenceand so we're proud of running a tightship on top of spanner and so we've gotour our flag on the castle flying highthere to celebrate thatspanner has significantly reduced ourtoil we save a ton of time and energy ontactical placement location distributionsharding scaling redundancy backupmanagement all of the things that letsus focus on delivering the value to ourusers and not managing ourinfrastructureand so for replicas we input the specsand spanner handle the change inreplication with adding and deletingshards the self-healing nature ofspanner such as automated indexverifications charting drainingguaranteed data consistency acrossregions it saves us a ton of workand so we rely on spanner toautomatically replicate data with fivenines availability ensuring our usersare confident their data is always safeand that same spanner sharding allows usto roll out incrementally and observehow changes perform which is a big winfor our reliabilityso kind of wrapping up on the principlesyou can see them around having a singleunified databasestrong consistency and high concurrencyenabling our ml workflows private andsecure by default and operationallyexcellentall that has helped us deliver anamazing product Google photos to see anamazing success running on spanner andthe numbers speak them for themselveswith over a billion users over 4trillion items in our Corpus spannersplays a huge role operating at thatscalephotos has experienced 10x growth sinceonboarding onto spanner and we'reconfident that we can scale another 10xand so it's really exciting what it'sallowed us to do and we can't wait tocontinue bringing more amazing featuresto all of our Google photos users thanksback to pratiba to wrap us upthanks John thanks for giving us abreath look at what you do with photosuh amazing partner for us hope duringthe session you found what why spannerwhat we did with spanner what we do withspanner inside of Google and amazingPartners like Google photos who leveragespanners to grow their business andDelight the customersso I just want to leave you withthis the amazing experience that we givewith to our external customers ourinternal customers as you'retransforming your businesses let B letus be your partners let's work with youto kind of bring your workloads on to nocompromise cloud cloud spanner with thatthanks for your time[Applause]foreign"
}